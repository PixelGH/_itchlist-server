<html>
    <head>
      <script src="https://unpkg.com/sweetalert/dist/sweetalert.min.js"></script>
      <meta charset="utf-8">
      <link rel="stylesheet" href="style.css">
      <script
            src="https://code.jquery.com/jquery-3.3.1.min.js"
            integrity="sha256-FgpCb/KJQlLNfOu91ta32o/NMZxltwRo8QtmkMRdAu8="
            crossorigin="anonymous"></script>
    </head>
    <body>
        <h1 id="name">_ich-List</h1>
        <p id="untertitel">Created by Marlon Zewen & Moritz Reinhold</h1>
        <div id="main">
        <h2 id="title"></h2>
        <p id="rest"></p>
        <div class="main-container">
            <input type="text" id="text-in">
            <div class="out" id="text-out"></div>
            <button onclick="check()">Prüfen</button>
        </div>
        <div id=players>
          <ul id="player-list">
          </ul>
        </div>
      </div>
        <script>
            $('#name').html(["Witch-List", "Rich-List", "Ritch's-List", "Which-List", "Mitch's-List"][Math.floor(Math.random()*5)])

            var list;
            var lockout = []

            let players = []

            let turn = 0

            $(document).ready(() => {
              swal({
                text: 'Anzahl der Spieler:',
                content: 'input',
                button: {
                  text: 'Ok',
                  closeModal: false
                }
              }).then((result) => {
                playerDialog(result)
              })
            })

            $.ajax('index.json').done((json) => {

              let index = JSON.parse(json)

              let lists = index.lists
              let listURL = lists[Math.floor(Math.random() * lists.length)]

              //let listURL = 'Lander_die_die_Mongolei_sind'
              //let listURL = 'James_Bond_Filme'

              $.ajax(`lists/${listURL}.json`).done((result) => {
                list = JSON.parse(result)
                $('#title').html(list.name)
                if (list.items.length - lockout.length == 1){
                $('#rest').html("Es befindet sich nur noch ein Element auf der Liste.")
                }else{
                $('#rest').html("Es befinden sich noch " + (list.items.length - lockout.length) + " Elemente auf der Liste.")}
              })
            })

            const playerDialog = (count) => {
              if (count == 0) {
                let list = ''
                var first = true
                for (var player of players) {
                  list += `<li id="player-${player.split(' ').join('')}" class="list-item ${first ? 'active-player' : ''}">${player}</li>`
                  first = false;
                }

                $('#player-list').html(list)
                return
              }
              swal({
                text: `Spieler ${count}`,
                content: 'input',
                button: {
                  text: 'Ok',
                  closeModal: count == 1 ? true : false
                }
              }).then((result) => {
                players.push(result ? result : `Spieler ${count}`)
                playerDialog(count - 1)
              })
            }

            const check = () => {
              let input = $('#text-in').val().toLowerCase().split(' ').join('')
              $('#text-in').val('')
              if (predicate(input, list.items)==1) {
                  let hit = list.items[lockout[lockout.length - 1]]
                  swal(`'${hit.name ? hit.name : (hit.names[0] + ` (${hit.names.slice(1).join(', ')})`)}'`, 'ist auf der Liste!', 'success').then((value) => {
                    if (lockout.length == list.items.length) {
                      swal('Liste vollständig', 'Sie haben alle ' + list.items.length + ' Elemente der Liste gennant.', 'info')
                    }
                  })
                  if (list.items.length - lockout.length == 1){
                    $('#rest').html("Es befindet sich nur noch ein Element auf der Liste.")
                  }else{
                  $('#rest').html("Es befinden sich noch " + (list.items.length - lockout.length) + " Elemente auf der Liste.")}
              } else if (predicate(input, list.items)==0){
                  swal(`'${input}'`, 'ist nicht auf der Liste.', 'error').then(() => {
                    $(`#player-${players[(turn - 1) % players.length].split(' ').join('')}`).addClass('out')
                    players.splice((turn - 1) % players.length, 1)
                    turn -= 1
                    if(players.length==1){
                      swal(`${players[0]} hat gewonnen.`, 'Ende',  'info')
                    }
                  })
              } else if (predicate(input, list.items)==2){
                  swal(`'${input}'`, 'wurde bereits gennant.', 'error')
              }
              if (input == "") {
                  $('#text-out').html("")
              } else {
                turn += 1
                $(`#player-${players[turn % players.length].split(' ').join('')}`).toggleClass('active-player')
                $(`#player-${players[(turn - 1) % players.length].split(' ').join('')}`).toggleClass('active-player')
              }
            }

            const predicate = (item, list) => {
              var result = 0

              for (var e of list) {
                if (((e.name ? e.name : "").toLowerCase().split(' ').join('') == item || (e.names ? e.names : []).map(i => i.toLowerCase().split(' ').join('')).includes(item)) && lockout.includes(list.indexOf(e))) {
                  result = 2
                } else if (((e.name ? e.name : "").toLowerCase().split(' ').join('') == item || (e.names ? e.names : []).map(i => i.toLowerCase().split(' ').join('')).includes(item))) {
                  result = 1
                  lockout.push(list.indexOf(e))
                }
              }
              return result;
            }
        </script>
    </body>
</html>
